# MonoGuard Zeabur 部署指南

本指南涵蓋如何將 MonoGuard 部署至 Zeabur 平台，包含 PostgreSQL 與 Redis。

## 先決條件

1. Zeabur 帳號：[zeabur.com](https://zeabur.com)
2. 連接至 Zeabur 的 GitHub 儲存庫
3. 網域名稱（選用，Zeabur 提供免費子網域）

## 專案結構

```
mono-guard/
├── apps/
│   ├── api/          # Go 後端服務
│   └── frontend/     # Next.js 網頁介面
├── zeabur.yaml       # Zeabur 部署設定
└── .env.example      # 環境變數範本
```

## 部署步驟

### 1. 環境變數設定

複製 `.env.example` 並在 Zeabur 控制台設定以下變數：

#### 必要變數
```bash
# 資料庫（由 Zeabur PostgreSQL 自動產生）
POSTGRES_PASSWORD=<auto-generated>
POSTGRES_USER=monoguard_user  
POSTGRES_DB=monoguard

# 快取（由 Zeabur Redis 自動產生）
REDIS_PASSWORD=<auto-generated>

# 認證
JWT_SECRET=<產生強密碼>
NEXTAUTH_SECRET=<產生強密碼>

# GitHub OAuth（用於使用者登入）
GITHUB_CLIENT_ID=<你的-github-app-id>
GITHUB_CLIENT_SECRET=<你的-github-app-secret>
```

#### 選用變數
```bash
# 分析
NEXT_PUBLIC_GA_MEASUREMENT_ID=G-XXXXXXXXXX

# 開發標誌
DEBUG=false
NODE_ENV=production
GO_ENV=production
```

### 2. GitHub OAuth 設定

1. 前往 GitHub → Settings → Developer settings → OAuth Apps
2. 建立新的 OAuth App：
   - **應用程式名稱**：MonoGuard
   - **首頁 URL**：`https://your-app.zeabur.app`
   - **授權回呼 URL**：`https://your-app.zeabur.app/api/auth/callback/github`
3. 將 Client ID 和 Client Secret 複製到 Zeabur 環境變數中

### 3. 部署至 Zeabur

#### 選項 A：GitHub 整合（推薦）
1. 將 GitHub 儲存庫連接至 Zeabur
2. Zeabur 會自動偵測 `zeabur.yaml`
3. 服務將自動部署：
   - PostgreSQL 資料庫
   - Redis 快取  
   - Go API 服務
   - Next.js 前端

#### 選項 B：手動部署
1. 從 GitHub 匯入專案
2. 手動設定服務：
   ```yaml
   # 服務將根據 zeabur.yaml 建立
   ```

### 4. 部署後設定

#### 資料庫遷移
API 服務會在啟動時自動執行資料庫遷移。

#### 健康檢查
- API：`https://your-api.zeabur.app/health`
- 前端：`https://your-app.zeabur.app`

#### 網域設定
1. 在 Zeabur 控制台新增自訂網域（選用）
2. 更新 `NEXTAUTH_URL` 環境變數
3. 更新 GitHub OAuth 回呼 URL

## 服務設定

### API 服務（`apps/api/`）
- **埠號**：8080
- **健康檢查**：`/health`
- **環境**：Go 1.21+
- **相依性**：PostgreSQL、Redis

### 前端服務（`apps/frontend/`）
- **埠號**：3000
- **框架**：Next.js 14
- **建置指令**：`npm run build`
- **相依性**：API 服務

### 資料庫服務
- **類型**：PostgreSQL 15
- **儲存**：持久磁碟區
- **備份**：自動每日備份

### 快取服務
- **類型**：Redis 7
- **記憶體**：依方案可設定
- **持久性**：選用

## 擴展設定

### 資源限制
```yaml
# 在 zeabur.yaml 中（選用）
services:
  api:
    resources:
      memory: 512Mi
      cpu: 0.5
  frontend:
    resources:
      memory: 256Mi
      cpu: 0.3
```

### 自動擴展
Zeabur 根據流量和資源使用量自動擴展。

## 監控與日誌

### 內建監控
- 在 Zeabur 控制台查看 CPU、記憶體、網路使用量
- 透過 Zeabur 介面查看應用程式日誌

### 自訂監控（選用）
在 API 中新增監控端點：
- `/metrics` - Prometheus 指標
- `/health` - 健康狀態

## 疑難排解

### 常見問題

#### 1. 資料庫連線失敗
- 檢查 `DATABASE_URL` 格式
- 確認 PostgreSQL 服務正在執行
- 檢查服務間網路連線

#### 2. 前端無法連接至 API
- 確認 `NEXT_PUBLIC_API_URL` 指向正確的 API 服務
- 檢查 API 中的 CORS 設定
- 確保兩個服務都已部署

#### 3. 認證問題
- 確認 GitHub OAuth 設定
- 檢查 `NEXTAUTH_SECRET` 是否已設定
- 確認回呼 URL 匹配

#### 4. 建置失敗
- 檢查 Dockerfiles 中的 Node.js/Go 版本
- 確認所有相依性都列在 package.json/go.mod 中
- 查看 Zeabur 控制台的建置日誌

### 日誌存取
```bash
# 在 Zeabur 控制台查看日誌或透過 CLI
zeabur logs <service-name>
```

## 成本最佳化

### 免費方案限制
- 查看 Zeabur 免費方案限制
- 監控資源使用量
- 考慮升級至正式環境方案

### 資源最佳化
- 最佳化 Docker 映像檔大小
- 使用正式環境建置
- 啟用壓縮與快取

## 安全最佳實務

### 環境變數
- 絕不將金鑰提交至儲存庫
- 使用強隨機值作為 JWT 金鑰
- 定期輪換金鑰

### 網路安全
- 啟用 HTTPS（Zeabur 自動提供）
- 正確設定 CORS
- 使用安全標頭

### 資料庫安全
- 使用強資料庫密碼
- 啟用 SSL 連線
- 定期安全更新

## 備份與復原

### 資料庫備份
- Zeabur 自動每日備份
- 重大變更前手動備份
- 定期測試還原程序

### 災難復原
- 記錄環境變數
- 維護部署手冊
- 測試復原程序

## 支援

### Zeabur 支援
- 文件：[docs.zeabur.com](https://docs.zeabur.com)
- 社群：Zeabur Discord/GitHub

### MonoGuard 支援  
- GitHub Issues：在儲存庫中建立議題
- 文件：查看專案 docs 資料夾

---

開發環境設定請參考 [DEVELOPMENT.md](./DEVELOPMENT.md)
一般部署選項請參考 [DEPLOYMENT.md](./DEPLOYMENT.md)