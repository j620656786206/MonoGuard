name: mono-guard

services:
  # PostgreSQL Database
  postgres:
    template: postgresql
    config:
      POSTGRES_DB: monoguard
      POSTGRES_USER: monoguard_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}

  # Redis Cache
  redis:
    template: redis
    config:
      REDIS_PASSWORD: ${REDIS_PASSWORD}

  # Go API Backend
  api:
    source:
      directory: ./apps/api
    dockerfile: ./apps/api/Dockerfile
    buildCommand: cd apps/api && go build -o main cmd/server/main.go
    startCommand: ./main
    env:
      DATABASE_URL: postgresql://${postgres.POSTGRES_USER}:${postgres.POSTGRES_PASSWORD}@${postgres.HOST}:${postgres.PORT}/${postgres.POSTGRES_DB}
      REDIS_URL: redis://:${redis.REDIS_PASSWORD}@${redis.HOST}:${redis.PORT}
      JWT_SECRET: ${JWT_SECRET}
      GITHUB_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}
      PORT: 8080
    ports:
      - 8080

  # Next.js Frontend
  frontend:
    source:
      directory: ./apps/frontend
    dockerfile: ./apps/frontend/Dockerfile
    buildCommand: cd apps/frontend && pnpm install && pnpm build
    startCommand: cd apps/frontend && pnpm start
    env:
      NEXT_PUBLIC_API_URL: https://${api.HOST}
      NEXTAUTH_URL: https://${ZEABUR_DOMAIN}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      DATABASE_URL: postgresql://${postgres.POSTGRES_USER}:${postgres.POSTGRES_PASSWORD}@${postgres.HOST}:${postgres.PORT}/${postgres.POSTGRES_DB}
    ports:
      - 3000

# Environment variables for the entire project
env:
  NODE_ENV: production
  GO_ENV: production
  TZ: Asia/Taipei
